<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2020-09-17 Thu 21:55 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>&lrm;</title>
<meta name="generator" content="Org mode" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:1f739d935676111cfff4b4693e3816e664797050&amp;dn=gpl-3.0.txt GPL-v3-or-Later
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.cacheClassElem = elem.className;
         elem.cacheClassTarget = target.className;
         target.className = "code-highlighted";
         elem.className   = "code-highlighted";
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(elem.cacheClassElem)
         elem.className = elem.cacheClassElem;
       if(elem.cacheClassTarget)
         target.className = elem.cacheClassTarget;
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgf23aa55">1. Design notes</a>
<ul>
<li><a href="#orga1e5374">1.1. JSON document generation request design for web client (BIEL)</a>
<ul>
<li><a href="#org83c0cbe">1.1.1. <span class="todo TODO">TODO</span> Question: What is the smallest level of resource request granularity we want: book, chapter, or verse?</a></li>
<li><a href="#org74a0d8a">1.1.2. <span class="todo TODO">TODO</span> for Craig: a license for the <code>Interleaved_Resources_Generator</code> project</a></li>
<li><a href="#org739cc27">1.1.3. Example request from <code>test_flask.py</code></a></li>
</ul>
</li>
<li><a href="#org4def12d">1.2. Interactions at a high level</a></li>
<li><a href="#org2c7e658">1.3. What works currently</a></li>
<li><a href="#org757a71d">1.4. Concept of resource in system</a></li>
<li><a href="#org9df6dbf">1.5. Docker container</a></li>
<li><a href="#org3120cc6">1.6. (Bonus/optional material) Convenience web service endpoints for BIEL UI to call (if desired)</a>
<ul>
<li><a href="#org32476b3">1.6.1. Example client call to get all language codes by themselves</a></li>
<li><a href="#orgab7ad41">1.6.2. Get all language code, language name pairs</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-orgf23aa55" class="outline-2">
<h2 id="orgf23aa55"><span class="section-number-2">1</span> Design notes</h2>
<div class="outline-text-2" id="text-1">
<p>
Let's start off with how BIEL sends a document generation request that
specifies what (arbitrary) combination of resources a user would like
included in the final PDF document.
</p>
</div>
<div id="outline-container-orga1e5374" class="outline-3">
<h3 id="orga1e5374"><span class="section-number-3">1.1</span> JSON document generation request design for web client (BIEL)</h3>
<div class="outline-text-3" id="text-1-1">
<p>
Requirement: Allow creating a document out of any combination of
resources from any supported (in translations.json) language.
</p>

<p>
At present we are at the stage of matching the functionality of the
prior system with respect to granularity of selection of bible
material, i.e., book-level granularity.
</p>

<p>
Currently the JSON looks like this, for example:
</p>

<div class="org-src-container">
<pre class="src src-js">{ "resources":
  { "lang_code": "am", "resource_type": "ulb", "resource_code": "gen" },
  { "lang_code": "lpx", "resource_type": "tn", "resource_code": "exo" },
  ...
}
</pre>
</div>

<p>
Each element in the JSON dictionary represents a resource. The whole
dictionary represents all the resources you want in the final typeset
document in the order you want them. Note that last point, the order.
That could of course be changed, but I am for now making an assumption
that BIEL's wizard would compose a JSON document generation request
having resources in the order the user requested the documents
resources to be represented.
</p>
</div>

<div id="outline-container-org83c0cbe" class="outline-4">
<h4 id="org83c0cbe"><span class="section-number-4">1.1.1</span> <span class="todo TODO">TODO</span> Question: What is the smallest level of resource request granularity we want: book, chapter, or verse?</h4>
<div class="outline-text-4" id="text-1-1-1">
<p>
In the resource entries below note that I've changed <code>resource_code</code> to
<code>book_code</code> just because it might be a better name than <code>resource_code</code>.
</p>

<p>
Perhaps book level granularity is sufficient, but just covering it
here in case. More granular than book level would require a design
that I can envision but would require interrogating the resource
itself rather than just the translations.json API.
</p>

<p>
So, the following rest of this headline is probably a diversion, but
here it is just in case you want finer than book granularity.
</p>

<p>
If chapter is the finest granularity of a resource request, the JSON could be:
</p>
<div class="org-src-container">
<pre class="src src-js">{ "resources":
  { "lang_code": "am",
    "resource_type": "ulb",
    "book_code": "gen",
    "book_chapter": "1" }, // Get just chapter 1
  { "lang_code": "lpx",
    "resource_type": "tn",
    "book_code": "exo",
    "book_chapter": "" }, // Get the whole book
  ...
}
</pre>
</div>


<p>
If verse is the finest granularity of a resource request, the JSON could be:
</p>
<div class="org-src-container">
<pre class="src src-js">{ "resources":
  { "lang_code": "am",
    "resource_type": "ulb",
    "book_code": "gen",
    "book_chapter": "1",
    "verse_start": "1",
    "verse_end": "3" }, // Get chapter 1, verse 1-3
  { "lang_code": "am",
    "resource_type": "ulb",
    "book_code": "gen",
    "book_chapter": "1",
    "verse_ranget": "1-1" }, // Or, Get chapter 1, verse 1
  { "lang_code": "am",
    "resource_type": "ulb",
    "book_code": "gen",
    "book_chapter": "1",
    "verse_ranget": "1-3" }, // Or, Get chapter 1, verse 1-3
  { "lang_code": "am",
    "resource_type": "ulb",
    "book_code": "gen",
    "book_chapter": "1",
    "verse_ranget": "1-3,5" }, // Or, Get chapter 1, verse 1-3 and verse 5
  { "lang_code": "lpx",
    "resource_type": "tn",
    "book_code": "exo",
    "book_chapter": "2" }, // Get chapter 2
  { "lang_code": "lpx",
    "resource_type": "tn",
    "book_code": "exo",
    "book_chapter": "" }, // Get the whole book
  ...
}
</pre>
</div>

<p>
As said before in a slightly different context, ideally from a user
experience perspective, BIEL would need to know what chapters or
verses are available so as not to disappoint the user. Nevertheless,
the system is being designed to gracefully handle such disappointments
as I know this is a requirement.
</p>
</div>
</div>
<div id="outline-container-org74a0d8a" class="outline-4">
<h4 id="org74a0d8a"><span class="section-number-4">1.1.2</span> <span class="todo TODO">TODO</span> for Craig: a license for the <code>Interleaved_Resources_Generator</code> project</h4>
<div class="outline-text-4" id="text-1-1-2">
<p>
I need a license emailed to me that I can check in to the repo. Or you
can send me a link to the license and I'll get it there. Thanks!
</p>
</div>
</div>
<div id="outline-container-org739cc27" class="outline-4">
<h4 id="org739cc27"><span class="section-number-4">1.1.3</span> Example request from <code>test_flask.py</code></h4>
<div class="outline-text-4" id="text-1-1-3">
<p>
Example python client request using resources JSON dictionary to submit an
API call to generate a document composed of resources.
</p>

<div class="org-src-container">
<pre class="src src-python">import json
import requests

payload = {}
payload["resources"] = [
    {"lang_code": "am",
     "resource_type": "ulb",
     "resource_code": ""},
    {"lang_code": "erk-x-erakor",
     "resource_type": "reg",
     "resource_code": "eph"},
    {"lang_code": "ml",
     "resource_type": "ulb",
     "resource_code": "tit"},
    {"lang_code": "ml",
     "resource_type": "obs-tq",
     "resource_code": ""},
    {"lang_code": "mr",
     "resource_type": "udb",
     "resource_code": "mrk"},
]


res = requests.post("http://localhost:5005/api/v1/document", json=json.dumps(payload))
if res.ok:
    print(res.json())
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org4def12d" class="outline-3">
<h3 id="org4def12d"><span class="section-number-3">1.2</span> Interactions at a high level</h3>
<div class="outline-text-3" id="text-1-2">

<div class="figure">
<p><img src="wa_design_sequence_diagram1.png" alt="wa_design_sequence_diagram1.png" />
</p>
</div>


<p>
<code>DocumentGenerator</code> passes back a JSON dict containing any messaging and
the eventual location of the generated document for display to the
requesting user (by BIEL).
</p>


<div class="figure">
<p><img src="wa_design_sequence_diagram2.png" alt="wa_design_sequence_diagram2.png" />
</p>
</div>

<p>
Note that, of course, <code>DocumentGenerator</code> iterates through the resources
and submits each resource to be found and provisioned, so "find
resource" in the image above is happening in a loop through each
resource. Similary for <code>ResourceDownloader</code>.
</p>


<div class="figure">
<p><img src="wa_design_class_diagram.png" alt="wa_design_class_diagram.png" />
</p>
</div>



<div class="figure">
<p><img src="wa_design_class_diagram2.png" alt="wa_design_class_diagram2.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-org2c7e658" class="outline-3">
<h3 id="org2c7e658"><span class="section-number-3">1.3</span> What works currently</h3>
<div class="outline-text-3" id="text-1-3">
<ol class="org-ol">
<li>Making a request for document generation to the web service (flask) running.</li>
<li>The resources that comprise the document generation request can handle a book-level of request granularity at present.</li>
<li>Resources are found and provisioned to disk (but not yet typeset into a final document).</li>
</ol>
<p>
Files involved: <code>flask_app.py</code>, <code>resource_lookup.py</code>,
<code>document_generator.py</code> (and <code>config.py</code>, <code>file_utils.py</code>, <code>url_utils.py</code>).
</p>
</div>
</div>
<div id="outline-container-org757a71d" class="outline-3">
<h3 id="org757a71d"><span class="section-number-3">1.4</span> Concept of resource in system</h3>
<div class="outline-text-3" id="text-1-4">
<p>
What follows is more than you really need to know, but I feel it is
worth an explanation since you are observing the evolution of a code
base that is very much in flux and far from complete.
</p>

<p>
At present, because the final form of the data structures are not yet
solidified I have found it advantageous to pass around a dictionary
that is a reification of the original JSON document generation request
(this is seen in both <code>ResourceJsonLookup</code> and <code>DocumentGenerator</code>. This
has been nice because prior to refactoring the legacy portion of this
system, <code>export_md_to_pdf.py</code> (which is now named
<code>document_generator.py</code>), I can update said dictionary with fields as I
need them. A dictionary during this stage of development provides the
flexibility to not commit to a design yet. Adding additional key/value
pairs to the dictionary like <code>resource_dir</code>, <code>resource_file_format</code>, etc.
is simple. These additional fields store data that are important for a
resource to know about itself so that its related files can be
provisioned to disk and subsequently found and used by the document
generation processes themselves (for things like Markdown to HTML
conversion, HTML to PDF conversion, etc..).
</p>

<p>
The use of the dictionary may (likely) change as the proper data
structures emerge from the evolving design. Of course, this is
solution domain stuff and so not something you should be concerning
yourself with as it doesn't have to do with requirements. Things will
continue to change from iteration to iteration.
</p>
</div>
</div>
<div id="outline-container-org9df6dbf" class="outline-3">
<h3 id="org9df6dbf"><span class="section-number-3">1.5</span> Docker container</h3>
<div class="outline-text-3" id="text-1-5">
<p>
There isn't much to say about the docker container except that it
provides the runtime environment, obviously. The only significant new
detail is that flask can be specified to run on a particular IP and
port (seen in <code>docker-compose.yaml</code>) which BIEL will know and use when
submitting requests.
</p>

<p>
In a later iteration toward the end, flask will presumably be load
balanced. Further, to protect its pool of workers from being tied up
by long running client requests from BIEL, one can adopt an
architecture such as the one described in the next paragraph.
</p>

<p>
nginx in front of gnunicorn in front of flask could be put in place to
handle load balancing incoming front end requests from BIEL. To learn
why you might do something like that please see this <a href="https://stackoverflow.com/questions/20766684/what-benefit-is-added-by-using-gunicorn-nginx-flask#20766961">stackoverflow
answer</a>
</p>

<p>
I am not bothering myself with this at all right now, just
mentioning it. There are plenty of other architectures that could be
used when we get there.
</p>
</div>
</div>
<div id="outline-container-org3120cc6" class="outline-3">
<h3 id="org3120cc6"><span class="section-number-3">1.6</span> (Bonus/optional material) Convenience web service endpoints for BIEL UI to call (if desired)</h3>
<div class="outline-text-3" id="text-1-6">
<p>
A nice property for a system like this to have is a ground truth data
source so that front end (BIEL) and back end are on same page about
what resources are available.
</p>

<p>
For now, that ground truth data source is the latest copy of
translations.json that <code>ResourceJsonLookup</code> obtains and keeps fresh to
within each 24 hour window. (This works fine, but I may make this more
sophisticated later).
</p>

<p>
Toward that goal of one ground truth data source for BIEL and this
system to coincide with this system provides to BIEL a couple of web
app endpoints that it can request data from to populate its dropdown
menu's in BIEL's document request wizard. These endpoints were easy to
make, so I am providing them.
</p>

<p>
It would be a bad user experience for BIEL users to be able to request
a resource which does not exist (but that is outside my scope per
requirements). For now, if these endpoints are used, we at least make
sure only languages that are provided in (the same version of)
translations.json are available for selection. Maybe later we'll go
further and actually provide endpoints that return the resources
available per language also. If those endpoints were built, they could
also be used by BIEL to populate resource type and book dropdown
menus. Just putting it out there though we haven't talked about it.
</p>

<p>
The system is being designed to gracefully handle non-existent
requested resources per requirements, but naturally you'd want to
avoid this if possible.
</p>

<p>
These endpoints were quick to create and were used in part to test
flask and jsonpath performance (you'll note that it is one place I
don't use jsonpath since performance in this one case was
unacceptable). So consider these endpoints a happy byproduct of
development, but that could be expanded to provide a better overall
user expeience if desired.
</p>
</div>
<div id="outline-container-org32476b3" class="outline-4">
<h4 id="org32476b3"><span class="section-number-4">1.6.1</span> Example client call to get all language codes by themselves</h4>
<div class="outline-text-4" id="text-1-6-1">
<p>
Example client call from <code>test_flask.py</code>:
</p>

<div class="org-src-container">
<pre class="src src-python">import json
import requests

res = requests.get("http://localhost:5005/api/v1/language_codes")
if res.ok:
print(res.json()) # Presumably, BIEL'll display it in a drop down menu or similar.
</pre>
</div>
</div>
</div>
<div id="outline-container-orgab7ad41" class="outline-4">
<h4 id="orgab7ad41"><span class="section-number-4">1.6.2</span> Get all language code, language name pairs</h4>
<div class="outline-text-4" id="text-1-6-2">
<p>
Example client call from <code>test_flask.py</code>.
</p>

<div class="org-src-container">
<pre class="src src-python">import json
import requests

res = requests.get("http://localhost:5005/api/v1/language_codes_and_names")
if res.ok:
    print(res.json()) # Presumably, BIEL'll display it in a drop down menu or similar.
</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Created: 2020-09-17 Thu 21:55</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
